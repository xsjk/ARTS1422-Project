<script setup>
	import Heatmap from './components/heatmap.vue'
	import Districtmap from './components/district_division.vue'
	import Calendar from './components/d3/Calendar.vue'
	import {SelectedDate} from './composables/d3/calendar/calendar'
	import {SelectedTime} from './composables/d3/calendar/pie'
	import Title from './components/d3/Title.vue'
	import { ref } from 'vue';
	import { computed} from 'vue';
	import * as d3 from 'd3';
	import HeatmapOverlay from 'heatmap.js/plugins/leaflet-heatmap';
	import L from 'leaflet';
	import { discreteScheme } from './composables/color/scheme.js';
	
	var heatmapTest = [];
	const testData2 = {
		max:100,
		data:[{'lng': 110.38890625, 'lat': 20.033906249999998, 'count': 0},
			 {'lng': 110.38890625, 'lat': 20.02421875, 'count': 0},
			 {'lng': 110.38164062499999, 'lat': 20.036328124999997, 'count': 0},
			 {'lng': 110.38164062499999, 'lat': 20.031484374999998, 'count': 0},
			 {'lng': 110.376796875, 'lat': 20.036328124999997, 'count': 1},
			 {'lng': 110.376796875, 'lat': 20.031484374999998, 'count': 0},
			 {'lng': 110.38164062499999, 'lat': 20.026640625, 'count': 4},
			 {'lng': 110.38164062499999, 'lat': 20.021796875, 'count': 8},
			 {'lng': 110.376796875, 'lat': 20.026640625, 'count': 10},
			 {'lng': 110.376796875, 'lat': 20.021796875, 'count': 6},
			 {'lng': 110.38890625, 'lat': 20.01453125, 'count': 0},
			 {'lng': 110.38890625, 'lat': 20.004843750000003, 'count': 0},
			 {'lng': 110.38164062499999, 'lat': 20.016953125, 'count': 0},
			 {'lng': 110.38164062499999, 'lat': 20.012109375, 'count': 2},
			 {'lng': 110.376796875, 'lat': 20.016953125, 'count': 2},
			 {'lng': 110.376796875, 'lat': 20.012109375, 'count': 10},
			 {'lng': 110.38164062499999, 'lat': 20.007265625000002, 'count': 0},
			 {'lng': 110.38164062499999, 'lat': 20.002421875000003, 'count': 0},
			 {'lng': 110.376796875, 'lat': 20.007265625000002, 'count': 3},
			 {'lng': 110.376796875, 'lat': 20.002421875000003, 'count': 4},
			 {'lng': 110.371953125, 'lat': 20.036328124999997, 'count': 3},
			 {'lng': 110.371953125, 'lat': 20.031484374999998, 'count': 9},
			 {'lng': 110.36710937500001, 'lat': 20.036328124999997, 'count': 2},
			 {'lng': 110.36710937500001, 'lat': 20.031484374999998, 'count': 10},
			 {'lng': 110.371953125, 'lat': 20.026640625, 'count': 6},
			 {'lng': 110.371953125, 'lat': 20.021796875, 'count': 9},
			 {'lng': 110.36710937500001, 'lat': 20.026640625, 'count': 10},
			 {'lng': 110.36710937500001, 'lat': 20.021796875, 'count': 15},
			 {'lng': 110.36226562499999, 'lat': 20.036328124999997, 'count': 7},
			 {'lng': 110.36226562499999, 'lat': 20.031484374999998, 'count': 11},
			 {'lng': 110.357421875, 'lat': 20.036328124999997, 'count': 10},
			 {'lng': 110.357421875, 'lat': 20.031484374999998, 'count': 8},
			 {'lng': 110.36226562499999, 'lat': 20.026640625, 'count': 8},
			 {'lng': 110.36226562499999, 'lat': 20.021796875, 'count': 5},
			 {'lng': 110.357421875, 'lat': 20.026640625, 'count': 17},
			 {'lng': 110.357421875, 'lat': 20.021796875, 'count': 10},
			 {'lng': 110.371953125, 'lat': 20.016953125, 'count': 8},
			 {'lng': 110.371953125, 'lat': 20.012109375, 'count': 13},
			 {'lng': 110.36710937500001, 'lat': 20.016953125, 'count': 0},
			 {'lng': 110.36710937500001, 'lat': 20.012109375, 'count': 8},
			 {'lng': 110.371953125, 'lat': 20.007265625000002, 'count': 9},
			 {'lng': 110.371953125, 'lat': 20.002421875000003, 'count': 13},
			 {'lng': 110.36710937500001, 'lat': 20.007265625000002, 'count': 9},
			 {'lng': 110.36710937500001, 'lat': 20.002421875000003, 'count': 13},
			 {'lng': 110.36226562499999, 'lat': 20.016953125, 'count': 2},
			 {'lng': 110.36226562499999, 'lat': 20.012109375, 'count': 12},
			 {'lng': 110.357421875, 'lat': 20.016953125, 'count': 5},
			 {'lng': 110.357421875, 'lat': 20.012109375, 'count': 4},
			 {'lng': 110.36226562499999, 'lat': 20.007265625000002, 'count': 7},
			 {'lng': 110.36226562499999, 'lat': 20.002421875000003, 'count': 5},
			 {'lng': 110.357421875, 'lat': 20.007265625000002, 'count': 7},
			 {'lng': 110.357421875, 'lat': 20.002421875000003, 'count': 10},
			 {'lng': 110.38890625, 'lat': 19.995156249999997, 'count': 0},
			 {'lng': 110.391328125, 'lat': 19.987890625, 'count': 0},
			 {'lng': 110.391328125, 'lat': 19.983046875, 'count': 0},
			 {'lng': 110.38648437500001, 'lat': 19.987890625, 'count': 3},
			 {'lng': 110.38648437500001, 'lat': 19.983046875, 'count': 5},
			 {'lng': 110.38164062499999, 'lat': 19.997578124999997, 'count': 1},
			 {'lng': 110.38164062499999, 'lat': 19.992734374999998, 'count': 11},
			 {'lng': 110.376796875, 'lat': 19.997578124999997, 'count': 3},
			 {'lng': 110.376796875, 'lat': 19.992734374999998, 'count': 4},
			 {'lng': 110.38164062499999, 'lat': 19.987890625, 'count': 15},
			 {'lng': 110.38164062499999, 'lat': 19.983046875, 'count': 2},
			 {'lng': 110.376796875, 'lat': 19.987890625, 'count': 14},
			 {'lng': 110.376796875, 'lat': 19.983046875, 'count': 10},
			 {'lng': 110.391328125, 'lat': 19.978203125, 'count': 3},
			 {'lng': 110.391328125, 'lat': 19.973359375, 'count': 1},
			 {'lng': 110.38648437500001, 'lat': 19.978203125, 'count': 0},
			 {'lng': 110.38648437500001, 'lat': 19.973359375, 'count': 1},
			 {'lng': 110.38890625, 'lat': 19.966093750000002, 'count': 0},
			 {'lng': 110.38164062499999, 'lat': 19.978203125, 'count': 0},
			 {'lng': 110.38164062499999, 'lat': 19.973359375, 'count': 2},
			 {'lng': 110.376796875, 'lat': 19.978203125, 'count': 1},
			 {'lng': 110.376796875, 'lat': 19.973359375, 'count': 0},
			 {'lng': 110.37921874999999, 'lat': 19.966093750000002, 'count': 0},
			 {'lng': 110.371953125, 'lat': 19.997578124999997, 'count': 3},
			 {'lng': 110.371953125, 'lat': 19.992734374999998, 'count': 4},
			 {'lng': 110.36710937500001, 'lat': 19.997578124999997, 'count': 9},
			 {'lng': 110.36710937500001, 'lat': 19.992734374999998, 'count': 0},
			 {'lng': 110.371953125, 'lat': 19.987890625, 'count': 0},
			 {'lng': 110.371953125, 'lat': 19.983046875, 'count': 0},
			 {'lng': 110.36710937500001, 'lat': 19.987890625, 'count': 14},
			 {'lng': 110.36710937500001, 'lat': 19.983046875, 'count': 14},
			 {'lng': 110.36226562499999, 'lat': 19.997578124999997, 'count': 5},
			 {'lng': 110.36226562499999, 'lat': 19.992734374999998, 'count': 12},
			 {'lng': 110.357421875, 'lat': 19.997578124999997, 'count': 7},
			 {'lng': 110.357421875, 'lat': 19.992734374999998, 'count': 3},
			 {'lng': 110.36226562499999, 'lat': 19.987890625, 'count': 19},
			 {'lng': 110.36226562499999, 'lat': 19.983046875, 'count': 4},
			 {'lng': 110.357421875, 'lat': 19.987890625, 'count': 3},
			 {'lng': 110.357421875, 'lat': 19.983046875, 'count': 0},
			 {'lng': 110.371953125, 'lat': 19.978203125, 'count': 0},
			 {'lng': 110.371953125, 'lat': 19.973359375, 'count': 3},
			 {'lng': 110.36710937500001, 'lat': 19.978203125, 'count': 3},
			 {'lng': 110.36710937500001, 'lat': 19.973359375, 'count': 2},
			 {'lng': 110.36953125000001, 'lat': 19.966093750000002, 'count': 0},
			 {'lng': 110.36226562499999, 'lat': 19.978203125, 'count': 3},
			 {'lng': 110.36226562499999, 'lat': 19.973359375, 'count': 0},
			 {'lng': 110.357421875, 'lat': 19.978203125, 'count': 1},
			 {'lng': 110.357421875, 'lat': 19.973359375, 'count': 0},
			 {'lng': 110.36226562499999, 'lat': 19.968515625000002, 'count': 0},
			 {'lng': 110.36226562499999, 'lat': 19.963671875000003, 'count': 0},
			 {'lng': 110.357421875, 'lat': 19.968515625000002, 'count': 0},
			 {'lng': 110.357421875, 'lat': 19.963671875000003, 'count': 1},
			 {'lng': 110.35257812500001, 'lat': 20.036328124999997, 'count': 8},
			 {'lng': 110.35257812500001, 'lat': 20.031484374999998, 'count': 9},
			 {'lng': 110.34773437500002, 'lat': 20.036328124999997, 'count': 2},
			 {'lng': 110.34773437500002, 'lat': 20.031484374999998, 'count': 20},
			 {'lng': 110.35257812500001, 'lat': 20.026640625, 'count': 11},
			 {'lng': 110.35257812500001, 'lat': 20.021796875, 'count': 15},
			 {'lng': 110.34773437500002, 'lat': 20.026640625, 'count': 10},
			 {'lng': 110.34773437500002, 'lat': 20.021796875, 'count': 7},
			 {'lng': 110.342890625, 'lat': 20.036328124999997, 'count': 6},
			 {'lng': 110.342890625, 'lat': 20.031484374999998, 'count': 7},
			 {'lng': 110.338046875, 'lat': 20.036328124999997, 'count': 15},
			 {'lng': 110.338046875, 'lat': 20.031484374999998, 'count': 19},
			 {'lng': 110.342890625, 'lat': 20.026640625, 'count': 27},
			 {'lng': 110.342890625, 'lat': 20.021796875, 'count': 6},
			 {'lng': 110.338046875, 'lat': 20.026640625, 'count': 24},
			 {'lng': 110.338046875, 'lat': 20.021796875, 'count': 15},
			 {'lng': 110.35257812500001, 'lat': 20.016953125, 'count': 2},
			 {'lng': 110.35257812500001, 'lat': 20.012109375, 'count': 4},
			 {'lng': 110.34773437500002, 'lat': 20.016953125, 'count': 1},
			 {'lng': 110.34773437500002, 'lat': 20.012109375, 'count': 2},
			 {'lng': 110.35257812500001, 'lat': 20.007265625000002, 'count': 7},
			 {'lng': 110.35257812500001, 'lat': 20.002421875000003, 'count': 7},
			 {'lng': 110.34773437500002, 'lat': 20.007265625000002, 'count': 2},
			 {'lng': 110.34773437500002, 'lat': 20.002421875000003, 'count': 3},
			 {'lng': 110.342890625, 'lat': 20.016953125, 'count': 1},
			 {'lng': 110.342890625, 'lat': 20.012109375, 'count': 6},
			 {'lng': 110.338046875, 'lat': 20.016953125, 'count': 3},
			 {'lng': 110.338046875, 'lat': 20.012109375, 'count': 6},
			 {'lng': 110.342890625, 'lat': 20.007265625000002, 'count': 2},
			 {'lng': 110.342890625, 'lat': 20.002421875000003, 'count': 15},
			 {'lng': 110.338046875, 'lat': 20.007265625000002, 'count': 20},
			 {'lng': 110.338046875, 'lat': 20.002421875000003, 'count': 14},
			 {'lng': 110.33320312500001, 'lat': 20.036328124999997, 'count': 6},
			 {'lng': 110.33320312500001, 'lat': 20.031484374999998, 'count': 8},
			 {'lng': 110.32835937500002, 'lat': 20.036328124999997, 'count': 10},
			 {'lng': 110.32835937500002, 'lat': 20.031484374999998, 'count': 6},
			 {'lng': 110.33320312500001, 'lat': 20.026640625, 'count': 15},
			 {'lng': 110.33320312500001, 'lat': 20.021796875, 'count': 20},
			 {'lng': 110.32835937500002, 'lat': 20.026640625, 'count': 11},
			 {'lng': 110.32835937500002, 'lat': 20.021796875, 'count': 9},
			 {'lng': 110.323515625, 'lat': 20.036328124999997, 'count': 0},
			 {'lng': 110.323515625, 'lat': 20.031484374999998, 'count': 13},
			 {'lng': 110.318671875, 'lat': 20.036328124999997, 'count': 0},
			 {'lng': 110.318671875, 'lat': 20.031484374999998, 'count': 12},
			 {'lng': 110.323515625, 'lat': 20.026640625, 'count': 17},
			 {'lng': 110.323515625, 'lat': 20.021796875, 'count': 12},
			 {'lng': 110.318671875, 'lat': 20.026640625, 'count': 31},
			 {'lng': 110.318671875, 'lat': 20.021796875, 'count': 12},
			 {'lng': 110.33320312500001, 'lat': 20.016953125, 'count': 9},
			 {'lng': 110.33320312500001, 'lat': 20.012109375, 'count': 6},
			 {'lng': 110.32835937500002, 'lat': 20.016953125, 'count': 11},
			 {'lng': 110.32835937500002, 'lat': 20.012109375, 'count': 1},
			 {'lng': 110.33320312500001, 'lat': 20.007265625000002, 'count': 8},
			 {'lng': 110.33320312500001, 'lat': 20.002421875000003, 'count': 6},
			 {'lng': 110.32835937500002, 'lat': 20.007265625000002, 'count': 9},
			 {'lng': 110.32835937500002, 'lat': 20.002421875000003, 'count': 0},
			 {'lng': 110.323515625, 'lat': 20.016953125, 'count': 5},
			 {'lng': 110.323515625, 'lat': 20.012109375, 'count': 8},
			 {'lng': 110.318671875, 'lat': 20.016953125, 'count': 8},
			 {'lng': 110.318671875, 'lat': 20.012109375, 'count': 0},
			 {'lng': 110.323515625, 'lat': 20.007265625000002, 'count': 11},
			 {'lng': 110.323515625, 'lat': 20.002421875000003, 'count': 9},
			 {'lng': 110.318671875, 'lat': 20.007265625000002, 'count': 2},
			 {'lng': 110.318671875, 'lat': 20.002421875000003, 'count': 4},
			 {'lng': 110.35257812500001, 'lat': 19.997578124999997, 'count': 11},
			 {'lng': 110.35257812500001, 'lat': 19.992734374999998, 'count': 7},
			 {'lng': 110.34773437500002, 'lat': 19.997578124999997, 'count': 3},
			 {'lng': 110.34773437500002, 'lat': 19.992734374999998, 'count': 2},
			 {'lng': 110.35257812500001, 'lat': 19.987890625, 'count': 17},
			 {'lng': 110.35257812500001, 'lat': 19.983046875, 'count': 4},
			 {'lng': 110.34773437500002, 'lat': 19.987890625, 'count': 7},
			 {'lng': 110.34773437500002, 'lat': 19.983046875, 'count': 1},
			 {'lng': 110.342890625, 'lat': 19.997578124999997, 'count': 17},
			 {'lng': 110.342890625, 'lat': 19.992734374999998, 'count': 7},
			 {'lng': 110.338046875, 'lat': 19.997578124999997, 'count': 17},
			 {'lng': 110.338046875, 'lat': 19.992734374999998, 'count': 7},
			 {'lng': 110.342890625, 'lat': 19.987890625, 'count': 16},
			 {'lng': 110.342890625, 'lat': 19.983046875, 'count': 3},
			 {'lng': 110.338046875, 'lat': 19.987890625, 'count': 4},
			 {'lng': 110.338046875, 'lat': 19.983046875, 'count': 16},
			 {'lng': 110.35257812500001, 'lat': 19.978203125, 'count': 0},
			 {'lng': 110.35257812500001, 'lat': 19.973359375, 'count': 0},
			 {'lng': 110.34773437500002, 'lat': 19.978203125, 'count': 2},
			 {'lng': 110.34773437500002, 'lat': 19.973359375, 'count': 0},
			 {'lng': 110.35257812500001, 'lat': 19.968515625000002, 'count': 1},
			 {'lng': 110.35257812500001, 'lat': 19.963671875000003, 'count': 1},
			 {'lng': 110.34773437500002, 'lat': 19.968515625000002, 'count': 0},
			 {'lng': 110.34773437500002, 'lat': 19.963671875000003, 'count': 0},
			 {'lng': 110.342890625, 'lat': 19.978203125, 'count': 1},
			 {'lng': 110.342890625, 'lat': 19.973359375, 'count': 1},
			 {'lng': 110.338046875, 'lat': 19.978203125, 'count': 1},
			 {'lng': 110.338046875, 'lat': 19.973359375, 'count': 0},
			 {'lng': 110.342890625, 'lat': 19.968515625000002, 'count': 1},
			 {'lng': 110.342890625, 'lat': 19.963671875000003, 'count': 0},
			 {'lng': 110.338046875, 'lat': 19.968515625000002, 'count': 0},
			 {'lng': 110.338046875, 'lat': 19.963671875000003, 'count': 0},
			 {'lng': 110.33320312500001, 'lat': 19.997578124999997, 'count': 8},
			 {'lng': 110.33320312500001, 'lat': 19.992734374999998, 'count': 9},
			 {'lng': 110.32835937500002, 'lat': 19.997578124999997, 'count': 11},
			 {'lng': 110.32835937500002, 'lat': 19.992734374999998, 'count': 7},
			 {'lng': 110.33320312500001, 'lat': 19.987890625, 'count': 4},
			 {'lng': 110.33320312500001, 'lat': 19.983046875, 'count': 43},
			 {'lng': 110.32835937500002, 'lat': 19.987890625, 'count': 8},
			 {'lng': 110.32835937500002, 'lat': 19.983046875, 'count': 13},
			 {'lng': 110.323515625, 'lat': 19.997578124999997, 'count': 5},
			 {'lng': 110.323515625, 'lat': 19.992734374999998, 'count': 4},
			 {'lng': 110.318671875, 'lat': 19.997578124999997, 'count': 2},
			 {'lng': 110.318671875, 'lat': 19.992734374999998, 'count': 13},
			 {'lng': 110.323515625, 'lat': 19.987890625, 'count': 1},
			 {'lng': 110.323515625, 'lat': 19.983046875, 'count': 4},
			 {'lng': 110.318671875, 'lat': 19.987890625, 'count': 3},
			 {'lng': 110.318671875, 'lat': 19.983046875, 'count': 2},
			 {'lng': 110.33320312500001, 'lat': 19.978203125, 'count': 4},
			 {'lng': 110.33320312500001, 'lat': 19.973359375, 'count': 0},
			 {'lng': 110.32835937500002, 'lat': 19.978203125, 'count': 4},
			 {'lng': 110.32835937500002, 'lat': 19.973359375, 'count': 0},
			 {'lng': 110.33078125000002, 'lat': 19.966093750000002, 'count': 0},
			 {'lng': 110.323515625, 'lat': 19.978203125, 'count': 3},
			 {'lng': 110.323515625, 'lat': 19.973359375, 'count': 0},
			 {'lng': 110.318671875, 'lat': 19.978203125, 'count': 0},
			 {'lng': 110.318671875, 'lat': 19.973359375, 'count': 0},
			 {'lng': 110.32109375, 'lat': 19.966093750000002, 'count': 0}]
			};
	
	
	const cityScheme = discreteScheme(42, 42).reverse();
	const newdata = ref([]);
	const weatherData = ref([]);
	// 用来获取数据的组合
	const getData = async () => {
	  const detailedData = await d3.csv('./static/house_pricing.csv');
	  const coordinalData = await d3.csv('./static/house_pricing_normalized.csv');
	  const weatherTest = await d3.csv('weatherData_temp.csv');
	  //heatmapTest = await out_degree([], [], [110.355043, 20.004658], 11);
	  newdata.value = detailedData.map((d, i) => ({
	    ...d,
	    ...coordinalData[i],
	  }));
	  weatherData.value = weatherTest.map(d => d);
	  weatherData.value.forEach(d=>{
		  d['date'] = d['date'] + "UTC";
	  });
	};
	
	getData()
	const map = L.map('map', {
		center: [20.004658, 110.355043],
		zoom: 10,
		renderer: L.svg()
	})
	var testData = {
	  max: 0,
	  data: []
	};
	
	// 加入基础地图
	let baseLayer = L.tileLayer(
	  'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
		attribution: 'Haut-Gis-Org © OpenStreetMap'
	})
	baseLayer.addTo(map);
	
	// 加入其他层级
	let heatmapLayer = Heatmap.methods.generate_layer(testData);
	heatmapLayer.cfg.radius = 0.001;
	let districtLayer = Districtmap.methods.generate_layer(data,map);
	
	L.control.scale({ maxWidth: 200, metric: true, imperial: false }).addTo(map)
	let mixed = {
		'heatmapLayer': heatmapLayer,
		'districtLayer': districtLayer
		//'OpenStreetMap': baseLayer,
	}
	L.control.layers(null, mixed).addTo(map);
	
	map.on('zoomend mouseup', async(e) => {
		let scale = e.target.getZoom();
		let center = e.target.getCenter();
		let center_arr = [center.lng,center.lat];
		console.log(e.target.getBounds());
		Heatmap.methods.update_layer(scale,SelectedDate(),SelectedTime(), center_arr)
	});
</script>


<template>
	<div class="Time-Selection">
	<Calendar
		:data="
			weatherData.map((d) => ({
				date:new Date(d['date']),
				price:1,
			}))
		"
		:calendar_width="650"
		:cellSize="20"
		:clock_width="270"
		:clock_height="200"
	/>
	</div>
	<div class="Title"> 
		<Title
		:width="400"
		:height="200"
		:x="-8"
		:y="0"
		/>
	</div>
</template>

<style>
	.leaflet-container {
		height: 550px;
		width: 925px;
		max-width: 100%;
		max-height: 100%;
		position: absolute;
		left: 400px;
		top: 0px;
	}
	.Time-Selection{
		position: absolute;
		left: 400px;
		top: 560px;
		background-color: chocolate;
	}
	.Title{
		position: absolute;
		left: 0px;
		top:0px;
		background-color: aqua;
	}
	
</style>

